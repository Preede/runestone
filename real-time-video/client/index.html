<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>

    <div id="container">
        <div id="heading">
            <button id="capture" onclick="capture()">
                &#x2727;
            </button>
            <button id="play" onclick="openCamera()">
                &#9658;
            </button>
            <button id="pause" onclick="closeCamera()">
                &#10074;&#10074;
            </button>
        </div>
        <canvas id="stream" style="resize:both;"></canvas>
    </div>
    <script type="text/javascript">
        var ws = null;
        var stream = document.getElementById("stream");
        var container = document.getElementById("container");
        var context = stream.getContext("2d");
        var image = null;
        var imageEle =
            '<div id="##id" class="captured-frame"><img class="frame-image" src="##src" /><div class="frame-title"><a href="##href" download="##title">##title</a></div></div>';
        function adjustSize(width, height) {
            stream.width = width;
            stream.height = height;
            stream.style.width = width + "px";
            stream.style.height = height + "px";
            container.style.width = width + "px";
            container.style.height = height + "px";
            adjustPos();
        }

        function adjustPos() {
            //Adjust player
            $("#container").css("margin-top", function (index) {
                return $("window").height() / 2 + $("#container").height() / 2;
            });
            $("#container").css("margin-left", function (index) {
                return (
                    (window.innerWidth - $("#captures").width() - $("#container").width()) / 2
                );
            });
        }

        $(document).ready(function () {
            adjustPos();

            $("#pause").hide();
        });

        //FPS Calculation
        var currentFps = 0,
            fps = 0;

        function drawFrame(image) {
            var img = new Image();
            img.onload = function () {
                context.drawImage(img, 0, 0);
            };
            img.src = image;
        }

        function closeCamera() {
            $("#play").show();
            $("#pause").hide();
            ws.send("close");
        }

        function openCamera() {
            console.log("openCamera")
            ws = new WebSocket("ws://localhost:8080");
            var sizeReceived = false;
            ws.onopen = function () {
                ws.send("open");
            };

            ws.onerror = function (e) {
                console.log(e);
            };

            ws.onmessage = function (message) {
                var data = JSON.parse(message.data);
                switch (data.type) {
                    case "size":
                        adjustSize(data.width, data.height);
                        break;
                    case "frame":
                        if (!sizeReceived) {
                            sizeReceived = true;
                            ws.send("size");
                        }
                        image = "data:image/jpg;base64," + data.frame;
                        drawFrame(image);
                        break;
                }
            };
            $("#play").hide();
            $("#pause").show();
        }

        function capture() {
            console.log("Capture")
            var cap = document.getElementById("acapture");
            cap.href = image;
            cap.download = "" + new Date().getTime() + ".jpg";
            $("#acapture").click();
            var id = "" + new Date().getTime();
            var capImage = imageEle
                .replace("##id", id)
                .replace("##src", image)
                .replace("##href", image)
                .replace(/##title/g, "" + id + ".jpg");
            $("#captures").prepend(capImage);
        }
    </script>
</body>

</html>